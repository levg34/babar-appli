<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>When may I go?</title>
		<!--
		<link rel="stylesheet" href="meuh.css">
		<script src="meuh.js"></script>
		-->
		<script>
var notif_interval = 10
var hours_finish = 16
var minutes_finish = 30
var _stop = _stop || false;
var _intervalId = _intervalId || 0;

function stop() {
	_stop = true
	var inputs = document.getElementsByTagName("input")
	for (var i=0;i<inputs.length;++i) {
		inputs[i].removeAttribute("disabled")
	}
	clearInterval(_intervalId);
	document.getElementById("meuh").innerText = "";
}
		
function secondsToHms(d) {
	d = Number(d);
	var h = Math.floor(d / 3600);
	var m = Math.floor(d % 3600 / 60);
	var s = Math.floor(d % 3600 % 60);
	return ((h > 0 ? h + ":" + (m < 10 ? "0" : "") : "") + m + ":" + (s < 10 ? "0" : "") + s);
}

function time() {
	var remain = 0
	var _initial = new Date()
	var _final = new Date()
	_final.setHours(hours_finish)
	_final.setMinutes(minutes_finish)
	_final.setSeconds(0)
	remain = (_final - _initial)/1000

	return remain
}

function notif(showNotif) {
	var message = secondsToHms(time()) + ' remaining.'
	
	if (time()>0) {
		var options = {
		  body: message,
		  icon: "http://www.angelfire.com/art/babar/images/ft.gif"
		}
		if (showNotif) var notification = new Notification("Not yet...",options);
	} else {
		message = "It's time to go!"
		var options = {
		  body: message,
		  icon: "https://www.yvelines.fr/wp-content/uploads/2016/Babar-Wallpapers.jpg"
		}
		if (showNotif) var notification = new Notification("Babar",options);
	}
	
	document.getElementById('meuh').innerText = message
}

function notifyMe() {
  // Voyons si le navigateur supporte les notifications
  if (!("Notification" in window)) {
    alert("Ce navigateur ne supporte pas les notifications desktop");
  }

  // Voyons si l'utilisateur est OK pour recevoir des notifications
  else if (Notification.permission === "granted") {
    // Si c'est ok, créons une notification
	notif(true)
  }

  // Sinon, nous avons besoin de la permission de l'utilisateur
  // Note : Chrome n'implémente pas la propriété statique permission
  // Donc, nous devons vérifier s'il n'y a pas 'denied' à la place de 'default'
  else if (Notification.permission !== 'denied') {
    Notification.requestPermission(function (permission) {

      // Quelque soit la réponse de l'utilisateur, nous nous assurons de stocker cette information
      if(!('permission' in Notification)) {
        Notification.permission = permission;
      }

      // Si l'utilisateur est OK, on crée une notification
      if (permission === "granted") {
        notif(true)
      }
    });
  }

  // Comme ça, si l'utlisateur a refusé toute notification, et que vous respectez ce choix,
  // il n'y a pas besoin de l'ennuyer à nouveau.
}

function start() {
	_stop = false
	var inputs = document.getElementsByTagName("input")
	for (var i=0;i<inputs.length;++i) {
		inputs[i].setAttribute("disabled","")
	}
	notif_interval = document.getElementById("notif_interval").value
	hours_finish = document.getElementById("hours_finish").value
	minutes_finish = document.getElementById("minutes_finish").value
	;(function(){
		if (!_stop) {
			notifyMe();
			setTimeout(arguments.callee, notif_interval*1000*60);
		}
	})();
	_intervalId = setInterval(notif, 500);
}

		</script>
	</head>
	<body>
		I finish work at: <input type="number" id="hours_finish" value="16" min="0" max="23"/> : <input type="number" id="minutes_finish" value="30" min="0" max="59"/><br/><br/>
		Notified every: <input type="number" id="notif_interval" value="10" min="1" max="60"/> minutes.<br/><br/>
		<button onclick="start()">
			Start
		</button>
		<button onclick="alert('not implemented')">
			Disable notifications
		</button>
		<button onclick="stop()">
			Stop
		</button>
		<div id="meuh"></div>
	</body>
</html>